<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="q">
    <!-- 전체 qna 게시판 게시글 조회 -->
    <select id="qna_list" resultType="vo.QnaVO" parameterType="java.util.Map">
        select * from
        ( select rank() over(order by q_board_ref DESC) no, q.* 
          from ( select * from QNA_BOARD
          <trim prefix="where" prefixOverrides="or|and">
            <if test="user_id!=null">
                user_id like '%'||#{user_id}||'%'
            </if>
            <if test="subject!=null">
                or subject like '%'||#{subject}||'%'
            </if>
            <if test="content!=null">
                or content like '%'||#{content}||'%'
            </if>
          </trim>
        ) q )
        where no BETWEEN #{start} and #{end}
    </select>
    
    <!-- 페이지 메뉴에 필요한 전체 게시글 수 -->
    <select id="qna_count" resultType="int" parameterType="java.util.Map">
        select count(*) from QNA_BOARD
        <trim prefix="where" prefixOverrides="or|and">
            <if test="user_id!=null">
                user_id like '%'||#{user_id}||'%'
            </if>
            <if test="subject!=null">
                or subject like '%'||#{subject}||'%'
            </if>
            <if test="content!=null">
                or content like '%'||#{content}||'%'
            </if>
        </trim>
    </select>
    
    <!-- q_board_idx에 해당하는 게시글 하나를 조회(상세보기) -->
    <select id="qna_one" parameterType="int" resultType="vo.QnaVO">
        select * from QNA_BOARD where q_board_idx=#{q_board_idx}
    </select>
    
    <!-- 새 글 작성 -->
    <insert id="qna_insert2" parameterType="vo.QnaVO">
        insert into QNA_BOARD (
        	q_board_idx,
        	subject,
        	content,
        	user_id,
        	depth,
        	q_board_ref,
        	regdate
        ) values (
        	seq_board_idx.nextVal,
        	#{subject},
        	#{content,jdbcType=CLOB},
        	#{user_id,jdbcType=VARCHAR},
        	0, <!-- 기본 깊이는 0 -->
        	seq_board_idx.currVal, <!-- 새로운 글의 경우 qna_idx 값으로 설정 -->
        	sysdate <!-- 현재 날짜와 시간 삽입 -->
        )
    </insert>
    
    <!-- 글 수정하기 -->
    <update id="qna_update" parameterType="vo.QnaVO">
        update QNA_BOARD set subject=#{subject}, user_id=#{user_id}, content=#{content}
        where q_board_idx=#{q_board_idx}
    </update>
    
    <!-- 삭제하기 -->
    <delete id="qna_del_upd" parameterType="int">
        delete from QNA_BOARD where q_board_idx=#{q_board_idx}
    </delete>
    
    <!-- 답변 추가 전 자리확보 -->
	<update id="board_update_step" parameterType="vo.QnaVO">
		update QNA_BOARD set q_board_ref = q_board_ref + 1
		where q_board_ref=#{q_board_ref}
	</update>
    
    <!-- 부모 글의 depth 값을 가져오는 쿼리 -->
    <select id="getParentDepth" parameterType="int" resultType="int">
    	SELECT depth FROM QNA_BOARD WHERE q_board_idx = #{q_board_ref}
    </select>
    
    <!-- 답변 작성 -->
	<insert id="board_reply" parameterType="vo.QnaVO">
		insert into QNA_BOARD (
			q_board_idx,
			subject,
			content,
			user_id,
			depth,
			q_board_ref,
			regdate
		) values (
			seq_board_idx.nextVal,
			#{subject},
			#{content},
			#{user_id},
			#{depth}, <!-- 부모 글의 depth에서 +1 된 값이어야 함 -->
			#{q_board_ref}, <!-- 부모 글의 q_board_idx 값 -->
			sysdate
		)
	</insert>
    
</mapper>
